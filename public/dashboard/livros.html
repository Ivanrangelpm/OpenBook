<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/imgs/logo.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenBook | Livros</title>


    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/estilo.css" />
    <link rel="stylesheet" href="./../css/livros.css">

    <script src="../js/sessao.js"></script>
    <script src="../js/alerta.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
</head>
<!--onload="validarSessao(), atualizarLivros()"-->
<body onload="validarSessao(), atualizarLivros()">

  <div class="header">
    <a href="index.html">
      <img src="../assets/imgs/logoExtendedCopy.png" alt="logo" class="logo">
    </a>
      <ul class="navbar">
        <li class="paginaAtual"> 
          <a class="paginaAtual" href="livros.html">Livros</a>
        </li>
        <li>
          <a href="../bobia.html">recomendAI</a>
        </li>
        <li>
          <a href="forum.html">Forum</a>
        </li>
        <li>|</li>
        <li >
          <a href="usuario.html">
            <div class="hello">
              <img id="fotoPerfil" alt="" style="display: none;">
              <img class="imgPerf" 
                  id="imgPerfil"
                  src="https://static.vecteezy.com/ti/vetor-gratis/p1/9734564-default-avatar-profile-icon-of-social-media-user-vetor.jpg"
                  alt="">
              <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>
          </a>
        </li>
        <li>
          <a>
            <div class="botaoSair" onclick="limparSessao()">
              <h3 style="color: #aa7744;" class="h3BotaoSair">Sair</h3>
          </div>
          </a>
        </li>
      </ul>
  </div>
    

    <div class="janela">


        
        <div class="containerLivros">
          Filtre o periodo: 
            <select name="" id="sel_tempo">
              <option  selected disabled value="0">Selecione um periodo de tempo</option>
              <option value="mes">Ultimo mês</option>
              <option value="semestre">Ultimo semestre</option>
              <option value="ano">Ultimo ano</option>
            </select>
            Filtre por genero
            <select name="" id="sel_genero">
              <option  selected disabled value="0">Selecione um genero</option>
              <option value="ficCientifica">Ficção Científica</option>
              <option value="terror">terror</option>              
              <option value="biografia">Biografia</option>
              <option value="aventura">Aventura</option>
              <option value="drama">drama</option>
              <option value="romance">Romance</option>
            </select>
            <button onclick="abrirCadastrarLivros()"> Cadastrar novo livro lido</button>

            <div id="divCadastrarLivros" class="cadastrarLivros">
              <h3>Cadastre seu novo livro lido</h3>
              Nome do Livro: <br> <input type="text" name="" id="inp_livroLido"> <br>
              Autor: <br><input type="text" name="" id="inp_autor"> <br>
              Genero: <br> <input type="text" name="" id="inp_genero"> <br>
              Nota: <br> <input type="text" name="" id="inp_nota"> <br>
              Data de leitura: <br> <input type="date" name="" id="inp_dtLeitura"> <br>
              Imagem: <br> <input type="text" name="" id="inp_imagem">
              <button onclick="cadastrarLivros()">Cadastrar Livro</button>
              <div id="erroLivroCadastrar"></div>
            </div>
            <div id="mensagemErro"></div>

            <div class="divContainerLivros" id="divContainerLivros">
              <div id="feedLivro1" class="containerCardLivros">

              </div>
  
              <div id="feedLivro2" class="containerCardLivros">
              </div> 
            </div>

        </div>

    </div>
 

</body>

<script>


function atualizarLivros() {
        fetch("/livro/listarLivros").then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    var feed = document.getElementById("mensagemErro");
                    var mensagem = document.createElement("h1");
                    mensagem.innerHTML = "Nenhum resultado encontrado."
                    feed.appendChild(mensagem);
                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));



                    var feed1 = document.getElementById("feedLivro1");
                    var feed2 = document.getElementById("feedLivro2");
                    feed1.innerHTML = "";
                    feed2.innerHTML = "";
                    
                    for (let i = 0; i < resposta.length; i++) {
                        var livro = resposta[i];

                        // criando e manipulando elementos do HTML via JavaScript
                        var divCard = document.createElement("div");
                        var nomeLivro = document.createElement("h1");
                        var btnAcessar = document.createElement("button");

                        nomeLivro.innerHTML = livro.nome ;
                        btnAcessar.innerHTML = "ACESSAR FÓRUM";

                        divCard.className = "cardForum";


                        btnAcessar.id = "btnAcessar" + livro.idLivro;
                        btnAcessar.setAttribute("onclick", `acessar(${livro.idLivro})`);

                        divCard.appendChild(nomeLivro);
                        divCard.appendChild(btnAcessar);
                        if(i < 5){
                            feed1.appendChild(divCard);
                        }else{
                            feed2.appendChild(divCard);
                        }
                        divCard.style.backgroundImage = `url('${livro.fotoLivro}')`;
                        
                    } 

                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }



    function cadastrarLivros(){
        var livroLido = inp_livroLido.value;
        var autor = inp_autor.value;
        var genero = inp_genero.value;
        var nota = Number(inp_nota.value)
        var dtLeitura = inp_dtLeitura.value;
        var fotoLivro = inp_imagem.value;
        var fkUsuario = sessionStorage.ID_USUARIO;


        if (fotoLivro == "") {
            fotoLivro = "https://img.freepik.com/vetores-premium/livro-fechado-marrom_135176-141.jpg"
        }

        if (livroLido == "" || autor == "" || genero == "" || nota == "" || dtLeitura == "") {
          erroLivroCadastrar.innerHTML = `Preencha todas as informações!`
        } else {
          erroLivroCadastrar.innerHTML = "";
            setTimeout(fecharCadastroLivro, 500);
        



        // Enviando o valor da nova input
        fetch("/livro/cadastrarLivro", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js

                nomeLivroServer: livroLido,
                autorServer: autor,
                generoServer: genero,
                notaServer: nota,
                dtLeituraServer: dtLeitura,
                fotoLivroServer: fotoLivro,
                fkUsuarioServer: fkUsuario
                
            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {

                    erroLivroCadastrar.innerHTML =
                        "";
                        atualizarLivros();
                } else {
                    throw "Houve um erro ao tentar realizar o cadastro do Forum!";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

        return false;
        }
      function fecharCadastroLivro() {
        divCadastrarLivros.style.display = 'none';
      }

    }

     function abrirCadastrarLivros() {
      divCadastrarLivros.style.display = 'block';

     }


     

 /*
Fazer uma lista de desejos para o usuario ler no futuro


 fazer um select para filtrar os livros que leu no ultimo mes / semestre / ano 
 e outro select para genero

 inp oninput com o nome do livro
 
 inp oninput nome do autor

 nota que o usuario dá para o livro 


 select com genero dos livros


 um botao para cadastrar novos livros lidos
 
 
 a função listar livros pode encrementar 3 listas com genero autores e nomes   
 */



</script>

</html>